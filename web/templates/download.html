<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{if .Error}}Door Sealed{{else if .Share}}{{.Share.Filename}} ‚Äî Durin's Door{{else}}Durin's Door{{end}}</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .rune-divider {
      text-align: center;
      color: var(--border-rune);
      font-size: 0.75rem;
      letter-spacing: 0.3em;
      margin: 1.5rem 0;
      opacity: 0.7;
    }
    .expiry-warning {
      color: #e09050;
      font-size: 0.82rem;
      font-style: italic;
      text-align: center;
      margin-top: 0.4rem;
    }
    .dl-count {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-align: center;
      margin-top: 0.35rem;
      font-style: italic;
    }
    .back-home {
      display: block;
      text-align: center;
      margin-top: 1.5rem;
      color: var(--text-dim);
      font-size: 0.8rem;
      text-decoration: none;
      opacity: 0.55;
      transition: opacity 0.2s;
    }
    .back-home:hover { opacity: 1; color: var(--silver); }
    .lock-icon {
      font-size: 1.4rem;
      display: block;
      text-align: center;
      margin-bottom: 0.6rem;
      filter: drop-shadow(0 0 6px rgba(201,168,76,0.5));
    }
  </style>
</head>
<body>

  <canvas id="stars-canvas"></canvas>
  <div class="mist-layer"></div>

  <div class="page-wrapper">

    <!-- ‚îÄ‚îÄ Small arch watermark ‚îÄ‚îÄ -->
    <div style="margin-bottom:1.5rem; opacity:0.55;">
      <svg width="60" height="72" viewBox="0 0 60 80" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="gs">
            <feGaussianBlur stdDeviation="2" result="b"/>
            <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <path fill="#0d1525" stroke="#2a3a5c" stroke-width="1"
              fill-rule="evenodd"
              d="M 0 80 L 0 0 L 60 0 L 60 80 Z
                 M 10 78 L 10 42 Q 9 12 30 8 Q 51 12 50 42 L 50 78 Z"/>
        <path fill="#060910"
              d="M 10 78 L 10 42 Q 9 12 30 8 Q 51 12 50 42 L 50 78 Z"/>
        <path fill="none" stroke="var(--gold)" stroke-width="0.8" opacity="0.6"
              d="M 10 42 Q 9 12 30 8 Q 51 12 50 42"/>
        <!-- Star -->
        <g filter="url(#gs)" transform="translate(30,36)">
          <line x1="0" y1="-10" x2="0"  y2="10"  stroke="var(--silver-glow)" stroke-width="0.9"/>
          <line x1="-10" y1="0" x2="10" y2="0"   stroke="var(--silver-glow)" stroke-width="0.9"/>
          <line x1="-7"  y1="-7" x2="7" y2="7"   stroke="var(--silver-glow)" stroke-width="0.8"/>
          <line x1="7"   y1="-7" x2="-7" y2="7"  stroke="var(--silver-glow)" stroke-width="0.8"/>
          <circle r="2" fill="var(--silver-glow)"/>
        </g>
      </svg>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         ERROR STATE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    {{if .Error}}
    <div class="download-card fade-in-up">
      <div class="error-card">
        <span class="error-glyph">üö™</span>
        <h1 class="error-title">The Door is Sealed</h1>
        <p class="error-message">{{.Error}}</p>
        <a href="/" class="btn-portal" style="max-width:220px; margin:0 auto; text-decoration:none;">
          <span class="btn-rune">‚Ü©</span> Return Home
        </a>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         DOWNLOAD STATE (share exists)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    {{else if .Share}}

    <div class="download-card fade-in-up">

      <!-- File icon + name -->
      <span class="file-icon">üìú</span>
      <p class="file-name">{{.Share.Filename}}</p>

      <!-- Meta grid -->
      <div class="meta-grid">
        <div class="meta-item">
          <span class="meta-label">Size</span>
          <span class="meta-value">{{.HumanSize}}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Expires In</span>
          <span class="meta-value">{{.ExpiresIn}}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Encryption</span>
          <span class="meta-value">AES-256-GCM</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Downloads</span>
          <span class="meta-value">
            {{if gt .Share.MaxDownloads 0}}
              {{.Share.Downloads}}&thinsp;/&thinsp;{{.Share.MaxDownloads}}
            {{else}}
              {{.Share.Downloads}} (‚àû)
            {{end}}
          </span>
        </div>
      </div>

      {{if .PasswordRequired}}
      <!-- Password badge -->
      <div style="text-align:center; margin-bottom:0.8rem;">
        <span class="badge badge-locked">üîë Password Required</span>
      </div>
      {{end}}

      <div class="rune-divider">¬∑ ¬∑ ·ö† ·ö¢ ·ö± ·ö® ¬∑ ¬∑ </div>

      <!-- Download form -->
      <form method="POST" id="dlForm">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />

        {{if .PasswordRequired}}
        <div class="password-section">
          <span class="lock-icon">üîê</span>
          <label for="password">Speak the word to open the door</label>
          <input type="password" id="password" name="password"
                 class="rune-input" placeholder="Enter the password‚Ä¶"
                 autocomplete="current-password" autofocus/>
          {{if .PasswordWrong}}
          <p class="error-rune">‚úï That is not the word. The door remains shut.</p>
          {{end}}
        </div>
        {{end}}

        <button type="submit" class="btn-portal" id="dlBtn">
          <span class="btn-rune">‚¨á</span>
          {{if .PasswordRequired}}Speak &amp; Receive the File{{else}}Open the Door &amp; Download{{end}}
        </button>

      </form>

      <!-- Progress bar (shown via JS after submit) -->
      <div class="download-progress" id="dlProgress">
        <div class="progress-label">Decrypting &amp; streaming‚Ä¶</div>
        <div class="progress-bar-track">
          <div class="progress-bar-fill" id="progressFill"></div>
        </div>
      </div>

      {{if gt .DownloadsRemaining 0}}
      <p class="dl-count">{{.DownloadsRemaining}} download{{if gt .DownloadsRemaining 1}}s{{end}} remaining</p>
      {{else if eq .Share.MaxDownloads 0}}
      <p class="dl-count">Unlimited downloads</p>
      {{end}}

    </div><!-- /.download-card -->

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         FALLBACK
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    {{else}}
    <div class="download-card fade-in-up">
      <div class="error-card">
        <span class="error-glyph">üåë</span>
        <h1 class="error-title">The Void</h1>
        <p class="error-message">Nothing stirs beyond this threshold.</p>
        <a href="/" class="btn-portal" style="max-width:220px; margin:0 auto; text-decoration:none;">
          <span class="btn-rune">‚Ü©</span> Return Home
        </a>
      </div>
    </div>
    {{end}}

    <a href="/" class="back-home">‚Üê Back to Durin's Door</a>

  </div><!-- /.page-wrapper -->

  <script>
  /* ‚îÄ‚îÄ Minimal star field ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  (function () {
    const cv = document.getElementById('stars-canvas');
    if (!cv) return;
    const cx = cv.getContext('2d');
    let W, H, stars = [], frame = 0;
    function resize() {
      W = cv.width  = window.innerWidth;
      H = cv.height = window.innerHeight;
      stars = [];
      const N = Math.min(Math.floor(W * H / 6000) + 40, 160);
      for (let i = 0; i < N; i++) {
        stars.push({
          x: Math.random() * W,
          y: Math.random() * H * 0.65,
          r: Math.random() * 1.2 + 0.2,
          phase: Math.random() * Math.PI * 2,
          speed: 0.005 + Math.random() * 0.015,
          blue: Math.random() < 0.2,
        });
      }
    }
    function draw() {
      cx.clearRect(0, 0, W, H);
      frame++;
      for (const s of stars) {
        const lum = 0.28 + 0.72 * (0.5 + 0.5 * Math.sin(s.phase + frame * s.speed));
        cx.fillStyle = s.blue
          ? `rgba(150,210,255,${lum})`
          : `rgba(215,205,185,${lum * 0.85})`;
        cx.beginPath();
        cx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
        cx.fill();
      }
      requestAnimationFrame(draw);
    }
    window.addEventListener('resize', resize, { passive: true });
    resize();
    draw();
  })();

  /* ‚îÄ‚îÄ Download progress animation ‚îÄ */
  (function () {
    const form = document.getElementById('dlForm');
    const btn  = document.getElementById('dlBtn');
    const prog = document.getElementById('dlProgress');
    const fill = document.getElementById('progressFill');
    if (!form || !btn || !prog) return;

    form.addEventListener('submit', function () {
      // Show progress bar with indeterminate animation
      prog.classList.add('visible');
      btn.disabled = true;
      btn.style.opacity = '0.6';

      // Animate progress bar (indeterminate ‚Äî we can't measure stream size)
      let pct = 0;
      const interval = setInterval(function () {
        // Ramp quickly to 85%, then slow down
        if (pct < 85) {
          pct += (85 - pct) * 0.04 + 0.3;
        } else if (pct < 97) {
          pct += 0.08;
        }
        fill.style.width = Math.min(pct, 97) + '%';
      }, 150);

      // Clean up after 60s (give up waiting)
      setTimeout(function () {
        clearInterval(interval);
        fill.style.width = '100%';
      }, 60000);
    });
  })();
  </script>

</body>
</html>
